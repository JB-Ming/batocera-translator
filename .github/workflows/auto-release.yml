name: Auto Release

on:
  push:
    branches: [main, master]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "language_packs/**"

jobs:
  check-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: get_tag
        run: |
          $ErrorActionPreference = "SilentlyContinue"
          $latestTag = git describe --tags --abbrev=0 2>&1
          $ErrorActionPreference = "Continue"
          if ($LASTEXITCODE -ne 0 -or -not $latestTag -or $latestTag -match "fatal:") {
            $latestTag = "v0.0.0"
          }
          Write-Output "Latest tag: $latestTag"
          echo "latest_tag=$latestTag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Calculate next version
        id: next_version
        run: |
          $currentTag = "${{ steps.get_tag.outputs.latest_tag }}"
          $version = $currentTag -replace '^v', ''
          $parts = $version -split '\.'

          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]

          # éå¢ patch ç‰ˆæœ¬
          $patch++

          $newVersion = "v$major.$minor.$patch"
          Write-Output "Current: $currentTag -> New: $newVersion"
          echo "version=$newVersion" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Check if should release
        id: should_release
        run: |
          $commitMsg = git log -1 --pretty=%B
          Write-Output "Commit message: $commitMsg"

          # æª¢æŸ¥ commit message æ˜¯å¦åŒ…å«ç‰¹å®šé—œéµå­—
          $shouldRelease = $false

          if ($commitMsg -match "^(feat|fix|perf|refactor):" -or 
              $commitMsg -match "\[release\]" -or
              $commitMsg -match "release:" -or
              $commitMsg -match "ç‰ˆæœ¬") {
            $shouldRelease = $true
          }

          Write-Output "Should release: $shouldRelease"
          echo "release=$shouldRelease" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Set up Python
        if: steps.should_release.outputs.release == 'True'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: steps.should_release.outputs.release == 'True'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Update version file
        if: steps.should_release.outputs.release == 'True'
        run: |
          $version = "${{ steps.next_version.outputs.version }}" -replace '^v', ''
          $content = @"
"""
ç‰ˆæœ¬è³‡è¨Š
æ­¤æª”æ¡ˆç”± GitHub Actions è‡ªå‹•æ›´æ–°ï¼Œè«‹å‹¿æ‰‹å‹•ä¿®æ”¹
"""

__version__ = "$version"
"@
          $content | Out-File -FilePath "src/version.py" -Encoding utf8 -NoNewline
          Write-Output "Updated version.py to $version"
        shell: pwsh

      - name: Build executable
        if: steps.should_release.outputs.release == 'True'
        run: |
          pyinstaller BatoceraTranslator.spec

      - name: Create release archive
        if: steps.should_release.outputs.release == 'True'
        run: |
          $version = "${{ steps.next_version.outputs.version }}"
          Compress-Archive -Path "dist\BatoceraTranslator\*" -DestinationPath "BatoceraTranslator-$version-Windows.zip"
        shell: pwsh

      - name: Generate release notes
        if: steps.should_release.outputs.release == 'True'
        id: release_notes
        run: |
          $prevTag = "${{ steps.get_tag.outputs.latest_tag }}"

          $lines = @()
          $lines += "## æ›´æ–°å…§å®¹"
          $lines += ""

          if ($prevTag -eq "v0.0.0") {
            $commits = git log --pretty=format:"- %s" -10
          } else {
            $commits = git log "$prevTag..HEAD" --pretty=format:"- %s"
          }

          if ($commits) {
            $lines += $commits
          } else {
            $lines += "- ç‰ˆæœ¬æ›´æ–°"
          }

          $lines += ""
          $lines += "---"
          $lines += ""
          $lines += "**ä¸‹è¼‰èªªæ˜ï¼š**"
          $lines += "- ä¸‹è¼‰ ``BatoceraTranslator-*-Windows.zip``"
          $lines += "- è§£å£“ç¸®å¾ŒåŸ·è¡Œ ``BatoceraTranslator.exe``"

          $lines | Out-File -FilePath "release_notes.md" -Encoding utf8
        shell: pwsh

      - name: Create Release
        if: steps.should_release.outputs.release == 'True'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.next_version.outputs.version }}
          name: BatoceraTranslator ${{ steps.next_version.outputs.version }}
          body_path: release_notes.md
          files: BatoceraTranslator-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip release notice
        if: steps.should_release.outputs.release != 'True'
        run: |
          Write-Output "â­ï¸ è·³éç™¼å¸ƒ - commit message ä¸ç¬¦åˆç™¼å¸ƒæ¢ä»¶"
          Write-Output "ğŸ’¡ æç¤ºï¼šåœ¨ commit message ä¸­ä½¿ç”¨ä»¥ä¸‹æ ¼å¼å¯è§¸ç™¼è‡ªå‹•ç™¼å¸ƒï¼š"
          Write-Output "   - feat: æ–°åŠŸèƒ½æè¿°"
          Write-Output "   - fix: ä¿®å¾©æè¿°"
          Write-Output "   - [release] ä»»ä½•è¨Šæ¯"
          Write-Output "   - release: ç™¼å¸ƒæè¿°"
        shell: pwsh
